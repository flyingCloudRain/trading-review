# 数据保存限制说明

## ⚠️ 重要提示

**AKShare API 只能获取实时数据，无法获取历史数据。**

这意味着：
- 当你在不同日期保存数据时，API 返回的都是**当前时刻的实时数据**
- 虽然可以指定 `target_date` 参数，但保存的数据实际上是**实时数据**，只是日期标记为指定的日期
- 这会导致不同日期的数据完全相同（因为它们都是同一天的实时数据）

## 🔍 问题示例

如果你在 2025-12-08 保存 2025-12-05 的数据：
- API 返回的是 2025-12-08 的实时数据
- 但数据被标记为 2025-12-05
- 结果：2025-12-05 和 2025-12-08 的数据完全相同

## ✅ 正确的使用方式

### 1. 使用定时任务自动保存（推荐）

定时任务会在每日 15:10（收盘后）自动执行，保存当天的数据：
- 使用 `target_date=None`，系统会自动判断日期
- 确保在交易日当天保存数据
- 数据日期会自动设置为当前交易日

### 2. 手动执行任务

如果需要在交易日当天手动保存数据：
- **不要指定 `target_date`**，让系统自动判断日期
- 或者确保 `target_date` 是今天（`get_utc8_date()`）

### 3. 避免的操作

❌ **不要**在非交易日保存历史数据：
```python
# 错误示例：在 12/08 保存 12/05 的数据
save_today_sectors(db, sector_type='industry', target_date=date(2025, 12, 5))
# 结果：保存的是 12/08 的实时数据，但标记为 12/05
```

✅ **正确做法**：只在交易日当天保存数据
```python
# 正确示例：让系统自动判断日期
save_today_sectors(db, sector_type='industry', target_date=None)
# 或者明确指定今天
save_today_sectors(db, sector_type='industry', target_date=get_utc8_date())
```

## 📊 如何检查数据是否正确

使用检查脚本：
```bash
# 检查指定日期的数据
python3 scripts/check_date_data.py --date 2025-12-08

# 比较两个日期的数据
python3 scripts/check_date_data.py --date1 2025-12-05 --date2 2025-12-08
```

如果两个日期的数据完全相同，说明它们是在同一天保存的实时数据。

## 🔧 解决方案

### 如果已经保存了错误的数据

1. **删除错误的数据**：
   - 通过数据库直接删除错误日期的数据
   - 或等待定时任务在正确日期重新保存数据（会覆盖旧数据）

2. **重新保存正确的数据**：
   - 在交易日当天执行定时任务
   - 确保数据日期正确

### 预防措施

系统已经添加了警告机制：
- 当 `target_date` 不是今天时，会显示警告信息
- 提醒用户 API 只能获取实时数据
- 建议只在交易日当天保存数据

## 📝 技术说明

### AKShare API 限制

以下接口都只能获取实时数据：
- `ak.stock_board_industry_summary_ths()` - 行业板块
- `ak.stock_fund_flow_concept()` - 概念板块
- `ak.stock_zt_pool_em()` - 涨停股票池
- `ak.stock_zt_pool_dtgc_em()` - 跌停股票池
- `ak.stock_zt_pool_zbgc_em()` - 炸板股票池
- `ak.stock_zh_index_spot_sina()` - 指数数据

这些接口**没有提供历史数据查询功能**，只能获取当前时刻的实时数据。

### 数据保存流程

1. 调用 API 获取实时数据
2. 将数据保存到数据库，日期字段设置为 `target_date`（如果指定）或自动判断的日期
3. 如果该日期已有数据，先删除旧数据，再保存新数据

**关键点**：API 返回的数据是实时的，与 `target_date` 无关。

## 💡 最佳实践

1. **使用定时任务**：让系统在交易日收盘后自动保存数据
2. **不要手动指定历史日期**：除非你确定要保存的是实时数据
3. **检查数据日期**：定期使用检查脚本验证数据是否正确
4. **注意警告信息**：当看到日期警告时，确认是否要继续

## 🔗 相关文档

- [定时任务配置](FUND_FLOW_SCHEDULER.md)
- [数据库表检查工具](../scripts/check_database_tables.py)
- [日期数据检查工具](../scripts/check_date_data.py)

